<!DOCTYPE html>
<html>

<head>
    <title>Functions : powered by cloudflare</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>cf proxy</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            background: rgb(255, 255, 255);
            color: rgb(255, 255, 255);
        }

        a {
            color: rgb(255, 255, 255);
        }

        del {
            color: rgb(255, 255, 255);
        }

        .center {
            text-align: center;
        }

        .important {
            font-weight: bold;
            font-size: 27;
        }

        /* my style begins*/
        form[id=urlForm] {
            margin: 0 auto;
        }

        input[id=targetUrl] {
            background-color: rgb(255, 255, 255);
        }

        button[id=jumpButton] {
            background-color: rgb(0, 255, 0);
        }
    </style>

    <script type="module">

        import { setupWorker } from 'msw/browser'
        import { handlers } from './handlers'
        import { http, HttpResponse } from 'msw'


        async function unregisterAll() {
            if (window.navigator && navigator.serviceWorker) {
                await navigator.serviceWorker.getRegistrations()
                    .then(async function (registrations) {
                        for (let registration of registrations) {
                            registration.active.postMessage('purge_cache');

                            await registration.unregister().then(function () {
                                console.log('Service worker unregistered successfully.');
                                // Optionally, reload the page after unregistration
                                // window.location.reload(true);
                            }).catch(function (error) {
                                console.error('Service worker unregistration failed:', error);
                            });

                        }
                    });
            }
        }
        function send_data(data) {
            navigator.serviceWorker.ready.then((registration) => {
                registration.active.postMessage(data);
            });
        }


        // Do something with cacheName.
        if ('serviceWorker' in navigator) {
            // await unregisterAll();

            //https://github.com/parcel-bundler/parcel/issues/8307
            //https://parceljs.org/features/targets/#implicit-environments
            //https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerGlobalScope/message_event

            const use_local_service = true;
            if (use_local_service) {
                // window.addEventListener('load', () => {
                var worker_url = new URL("./service-worker.js", import.meta.url);
                console.log(`import.meta.url ${import.meta.url}, worker_url ${worker_url}`);
                await navigator.serviceWorker.register(worker_url)
                    .then((registration) => {
                        if (registration.active) {
                            send_data('KEEPALIVE_REQUEST');
                            console.log('Service worker is active');
                        }
                    });
                // });
            } else {
                const handlers = [
                    http.all('*', async ({ request, params, cookies }) => {
                        console.log('Intercepted request to:', request.url);
                        const resp = await fetch(event.request);
                        console.log('Intercepted fetch resp:', resp);


                        // Optionally return a mocked response
                        return HttpResponse(resp.body, {
                            status: resp.status,
                            headers: resp.headers,
                        });
                    }),
                ];

                const worker = setupWorker(...handlers)
                await worker.start({
                    serviceWorker: {
                        // This is useful if your application follows
                        // a strict directory structure.
                        url: '/proxy/mockServiceWorker.js',
                    },
                }) // Promise<{ pending }>

            }


            navigator.serviceWorker.addEventListener("message", (event) => {
                console.log(`navigator.serviceWorker.addEventListener => message`);

                console.log(event.data);

                switch (event.data) {
                    case 'KEEPALIVE_RESPONSE': {
                        console.log(`KEEPALIVE`);
                        break
                    }
                }
            });



        }
    </script>

    <script>
        //https://stackoverflow.com/questions/179355/clearing-all-cookies-with-javascript
        function deleteAllcookies() {
            console.log("deleteAllcookies");
            document.cookie.split(";").forEach(function (c) { document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); });
        }
        function logout() {
            console.log("logout");

            deleteAllcookies();

        }
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        var current_url = new URL(document.URL);

        window.addEventListener('load', () => {
            const a = document.getElementById("fuck");

            if (a) {
                a.setAttribute("href", "/proxy/https://example.com")
            }

        })


    </script>
</head>

<body>
    {serive_worker}
    <form id="urlForm" onsubmit="redirectToProxy(event)">
        <fieldset>
            <legend>Proxy Everything</legend><label for="targetUrl">TargetUrl: <input type="text" id="targetUrl"
                    placeholder="Enter the target URL here..."></label><button type="submit"
                id="jumpButton">Jump!</button>
        </fieldset>
    </form>
    <script>function redirectToProxy(event) {
            event.preventDefault();
            var targetUrl = document.getElementById("targetUrl").value.trim();
            if (!targetUrl) return; if (!targetUrl.startsWith("http")) {
                targetUrl = "https://" + targetUrl;
            };
            const currentOrigin = window.location.origin;
            var pathname = `/proxy/${targetUrl}`;
            console.log(`pathname :${pathname}`);
            location.pathname = pathname;
        }
    </script>
</body>

</html>